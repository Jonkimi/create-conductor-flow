name: Publish to NPM

on:
  push:
    tags:
      - "v*"
permissions:
  id-token: write # Required for OIDC
  contents: read

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
        node-version: [24]

    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - run: npm ci
      - run: npm run build --if-present
      - run: npm test

  publish:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "24"
          registry-url: "https://registry.npmjs.org"

      - run: npm install -g npm@latest # Update npm to latest version for OIDC support
      - run: npm ci
      - run: npm run build --if-present
      # - run: npm publish --access public
      - name: Check version and Publish
        run: |
          # 1. 获取当前 package.json 的版本号
          VERSION=$(node -p "require('./package.json').version")
          echo "Current Version: $VERSION"

          # 2. 判断逻辑
          if [[ "$VERSION" == *"-"* ]]; then
            # ---------------------------------------------------
            # 情况一：预发布版本 (包含连字符，如 1.0.0-beta.1)
            # ---------------------------------------------------
            
            # 提取 tag 名字 (例如从 1.0.0-beta.1 提取出 "beta")
            # 逻辑：取第一个连字符后的单词，支持字母开头的标识符
            # 如果提取失败（如 1.0.0-1 纯数字），sed 会返回原字符串，需要回退为 "next"
            TAG=$(echo "$VERSION" | sed -r 's/^[0-9]+\.[0-9]+\.[0-9]+-([a-zA-Z][a-zA-Z0-9]*)([\.\-].*)?$/\1/')
            
            # 如果 TAG 为空、是纯数字、或等于原版本号（说明 sed 没匹配成功），降级为 next
            if [[ -z "$TAG" ]] || [[ "$TAG" =~ ^[0-9]+$ ]] || [[ "$TAG" == "$VERSION" ]]; then
              TAG="next"
            fi
            
            echo "⚠️ Prerelease detected. Publishing with tag: $TAG"
            npm publish --tag "$TAG"
            
          else
            # ---------------------------------------------------
            # 情况二：正式版本 (如 1.0.0)
            # ---------------------------------------------------
            echo "✅ Stable release detected. Publishing to latest."
            npm publish
          fi

      # -------------------------------------------------------
      # 发布副包：conductor-init
      # -------------------------------------------------------
      - name: Modify Alias Package
        run: |
          npm pkg set name="conductor-init"
          npm pkg set bin.conductor-init="./index.js"
          npm pkg delete bin.create-conductor-flow

          # 必须加上 --provenance，这样 npm 知道这是同一个仓库来的
          # npm publish --access public --provenance

      - name: Check version and Publish
        run: |
          # 1. 获取当前 package.json 的版本号
          VERSION=$(node -p "require('./package.json').version")
          echo "Current Version: $VERSION"

          # 2. 判断逻辑
          if [[ "$VERSION" == *"-"* ]]; then
            # ---------------------------------------------------
            # 情况一：预发布版本 (包含连字符，如 1.0.0-beta.1)
            # ---------------------------------------------------
            
            # 提取 tag 名字 (例如从 1.0.0-beta.1 提取出 "beta")
            # 逻辑：取第一个连字符后的单词，支持字母开头的标识符
            # 如果提取失败（如 1.0.0-1 纯数字），sed 会返回原字符串，需要回退为 "next"
            TAG=$(echo "$VERSION" | sed -r 's/^[0-9]+\.[0-9]+\.[0-9]+-([a-zA-Z][a-zA-Z0-9]*)([\.\-].*)?$/\1/')
            
            # 如果 TAG 为空、是纯数字、或等于原版本号（说明 sed 没匹配成功），降级为 next
            if [[ -z "$TAG" ]] || [[ "$TAG" =~ ^[0-9]+$ ]] || [[ "$TAG" == "$VERSION" ]]; then
              TAG="next"
            fi
            
            echo "⚠️ Prerelease detected. Publishing with tag: $TAG"
            npm publish --tag "$TAG"
            
          else
            # ---------------------------------------------------
            # 情况二：正式版本 (如 1.0.0)
            # ---------------------------------------------------
            echo "✅ Stable release detected. Publishing to latest."
            npm publish
          fi
